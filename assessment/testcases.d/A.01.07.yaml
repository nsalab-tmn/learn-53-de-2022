- name: Конфигурация application gateway
  code: s1
  type: check
  result:
  device: local
  action_chain:
    - action: validate_web_response
      action_vars:
        name: "{answer_endpoint_url}"
        assert_code: 200
    - action: run_shell_commands
      action_vars:
        commands:
          - az login --service-principal --username {client_id} --password {client_secret} --tenant {tenant_id}
          - ip=$(az network application-gateway show --name web53-AppGW --resource-group {learn_rg} --query "frontendIpConfigurations[*].publicIpAddress.id|[0]")
          - name=$(echo $ip | tr -d '"')
          - export url={answer_endpoint_url}
    - action: verify_output
      action_vars:
        command: az network public-ip list --resource-group {learn_rg} --query "[?id == '$name' && (contains('$url',ipAddress) || contains('$url',dnsSettings.fqdn))]"
        tags_are_present: True
        assert_tags:
          - "Microsoft.Network/publicIPAddresses"
